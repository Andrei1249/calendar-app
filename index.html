<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Calendar To-Do</title>

  <!-- PWA (opțional, dacă ai manifest + SW în repo) -->
  <link rel="manifest" href="manifest.webmanifest">
  <script>
    if ('serviceWorker' in navigator){
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>

  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --muted:#97a3b6; --text:#e9edf1;
      --accent:#4da3ff;       /* baby blue – VREA OFERTA */
      --green:#25c26e;        /* SEMNEAZA */
      --red:#ff4d4f;          /* delete / close X */
      --pink:#ff6eb3;         /* NU RASPUNDE */
      --yellow:#ffd166;       /* DE REVENIT */
      --divider:#212633;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{display:flex;flex-direction:column;height:100svh;max-width:720px;margin:0 auto}

    header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg);z-index:5}
    header h1{font-size:18px;margin:0;font-weight:600}
    .btn{border:1px solid var(--divider);background:transparent;color:var(--text);border-radius:10px;padding:6px 10px;font:inherit;cursor:pointer}

    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:10px 12px}
    .dow{opacity:.65;font-size:12px;text-align:center}
    .day{aspect-ratio:1/1;border:1px solid var(--divider);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none}
    .day.today{outline:2px solid var(--accent)}
    .day.selected{background:var(--card);border-color:var(--accent)}

    .tasks{flex:1;overflow:auto;padding:8px 12px;display:flex;flex-direction:column;gap:8px}
    .task{background:var(--card);border:1px solid var(--divider);border-radius:14px;padding:12px;position:relative;overflow:hidden}
    .task.done{opacity:.6;text-decoration:line-through}
    .task .meta{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--divider);color:var(--muted);letter-spacing:.3px}
    .tag.offer{background:rgba(77,163,255,.15);border-color:#387ed6;color:var(--accent)}
    .tag.sign{background:rgba(37,194,110,.17);border-color:#1ea45a;color:var(--green)}
    .tag.pink{background:rgba(255,110,179,.18);border-color:#ff6eb3;color:#ff8fc6}
    .tag.yellow{background:rgba(255,209,102,.18);border-color:#ffd166;color:#ffe08a}
    .note{font-size:12px;color:#cbd3df;opacity:.9;margin-top:6px;white-space:pre-wrap}

    .swipe-actions{position:absolute;inset:0;display:flex;justify-content:space-between;pointer-events:none}
    .swipe-left,.swipe-right{display:flex;align-items:center;padding:0 12px;opacity:.0;transition:opacity .12s}
    .swipe-left{justify-content:flex-start;color:var(--green)}
    .swipe-right{justify-content:flex-end;color:var(--red)}
    .task.swiping-left .swipe-left{opacity:.9}
    .task.swiping-right .swipe-right{opacity:.9}

    .task.highlight-offer{box-shadow:inset 0 0 0 9999px rgba(77,163,255,.13), 0 0 0 1px rgba(77,163,255,.3)}
    .task.highlight-sign{box-shadow:inset 0 0 0 9999px rgba(37,194,110,.13), 0 0 0 1px rgba(37,194,110,.35)}
    .task.highlight-pink{box-shadow:inset 0 0 0 9999px rgba(255,110,179,.12), 0 0 0 1px rgba(255,110,179,.28)}
    .task.highlight-yellow{box-shadow:inset 0 0 0 9999px rgba(255,209,102,.12), 0 0 0 1px rgba(255,209,102,.28)}

    /* FAB – puțin mai sus și mai în stânga față de margini */
    .fab{position:fixed;right:26px;bottom:26px;background:var(--accent);color:#08111f;border:none;border-radius:50%;width:56px;height:56px;font-size:30px;line-height:0;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:10;cursor:pointer}

    /* Buton „AZI” – vizibil doar când nu e selectată ziua de azi */
    .today-btn{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:var(--card);color:var(--text);border:1px solid var(--divider);border-radius:999px;padding:8px 14px;font:inherit;z-index:11;display:none;cursor:pointer}

    /* Modal overlay central (nu bottom-sheet) */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
    .modal{background:var(--card);width:min(92vw,560px);border-radius:16px;padding:16px;border:1px solid var(--divider);box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .modal h3{margin:0 0 8px 0;text-align:center}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field input,.field textarea{background:#0e121a;border:1px solid var(--divider);border-radius:10px;padding:10px;color:var(--text);font:inherit}
    .row{display:flex;gap:8px;justify-content:center;margin-top:6px}
    .iconbtn{border:1px solid var(--divider);background:#0e121a;border-radius:12px;padding:10px 14px;font-size:18px;cursor:pointer}
    .iconbtn.ok{color:#0d3; border-color:#0b4}
    .iconbtn.close{color:var(--red); border-color:#a33}

    .chipbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;justify-content:center}
    .chip{border:1px solid var(--divider);padding:8px 12px;border-radius:999px;cursor:pointer;letter-spacing:.4px}
    .chip[data-val="vrea_oferta"]{border-color:#387ed6;color:var(--accent)}
    .chip[data-val="semneaza"]{border-color:#1ea45a;color:var(--green)}
    .chip[data-val="nu_raspunde"]{border-color:#ff6eb3;color:#ff8fc6}
    .chip[data-val="de_revenit"]{border-color:#ffd166;color:#ffe08a}

    .empty{opacity:.6;text-align:center;margin-top:16px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <button class="btn" id="prevBtn">◀</button>
    <h1 id="monthLabel">Octombrie 2025</h1>
    <button class="btn" id="nextBtn">▶</button>
  </header>

  <div class="calendar" id="calendarGrid"></div>

  <!-- am scos bara de hint/instrucțiuni -->

  <div class="tasks" id="taskList"></div>

  <!-- FAB „+” mutat puțin mai sus și mai în interior -->
  <button class="fab" id="addBtn">＋</button>
  <!-- Buton „AZI” apare doar dacă nu e selectată ziua curentă -->
  <button class="today-btn" id="todayBtn">AZI</button>
</div>

<!-- Modal Add/Edit – overlay central -->
<div class="modal-bg" id="modalAddBg">
  <div class="modal">
    <h3>Task nou</h3>
    <div class="field">
      <label>Titlu</label>
      <input id="taskTitle" placeholder="Ex: Sun la X pentru ofertă">
    </div>
    <div class="field">
      <label>Notă (opțional)</label>
      <textarea id="taskNote" rows="3" placeholder="Detalii adiționale..."></textarea>
    </div>
    <div class="row">
      <button class="iconbtn close" id="cancelAdd">✕</button>
      <button class="iconbtn ok" id="saveAdd">✓</button>
    </div>
  </div>
</div>

<!-- Modal Tag (long-press) – overlay central -->
<div class="modal-bg" id="modalTagBg">
  <div class="modal">
    <h3>Alege tag</h3>
    <div class="chipbar">
      <div class="chip" data-val="nu_raspunde">NU RĂSPUNDE</div>
      <div class="chip" data-val="vrea_oferta">VREA OFERTĂ</div>
      <div class="chip" data-val="semneaza">SEMNEAZĂ</div>
      <div class="chip" data-val="de_revenit">DE REVENIT</div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="iconbtn close" id="cancelTag">✕</button>
    </div>
  </div>
</div>

<!-- Modal pick date pentru „DE REVENIT” – overlay central -->
<div class="modal-bg" id="modalDateBg">
  <div class="modal">
    <h3>Alege data pentru revenire</h3>
    <div class="field">
      <input type="date" id="returnDate">
    </div>
    <div class="row">
      <button class="iconbtn close" id="cancelDate">✕</button>
      <button class="iconbtn ok" id="saveDate">✓</button>
    </div>
  </div>
</div>

<script>
/* ===== Utils / Date ===== */
const roMonths = ["Ianuarie","Februarie","Martie","Aprilie","Mai","Iunie","Iulie","August","Septembrie","Octombrie","Noiembrie","Decembrie"];
const pad = n=>String(n).padStart(2,"0");
const toKey = (d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const fromKey = (k)=>{ const [y,m,dd]=k.split("-").map(Number); return new Date(y,m-1,dd); };
const today = new Date();
let current = new Date(today.getFullYear(), today.getMonth(), 1);
let selected = new Date(today.getFullYear(), today.getMonth(), today.getDate());

/* ===== Storage ===== */
const loadDay = (key)=> JSON.parse(localStorage.getItem("tasks:"+key) || "[]");
const saveDay = (key,arr)=> localStorage.setItem("tasks:"+key, JSON.stringify(arr));
const uuid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);

/* ===== UI Elements ===== */
const monthLabel = document.getElementById("monthLabel");
const calGrid = document.getElementById("calendarGrid");
const taskList = document.getElementById("taskList");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const addBtn  = document.getElementById("addBtn");
const todayBtn= document.getElementById("todayBtn");

/* Modals */
const modalAddBg = document.getElementById("modalAddBg");
const modalTagBg = document.getElementById("modalTagBg");
const modalDateBg= document.getElementById("modalDateBg");
const taskTitle  = document.getElementById("taskTitle");
const taskNote   = document.getElementById("taskNote");
const cancelAdd  = document.getElementById("cancelAdd");
const saveAdd    = document.getElementById("saveAdd");
const cancelTag  = document.getElementById("cancelTag");
const returnDate = document.getElementById("returnDate");
const cancelDate = document.getElementById("cancelDate");
const saveDate   = document.getElementById("saveDate");

let longPressTargetId = null;

/* ===== Calendar Render ===== */
function renderCalendar(){
  monthLabel.textContent = `${roMonths[current.getMonth()]} ${current.getFullYear()}`;
  calGrid.innerHTML = "";
  const dow = ["L","Ma","Mi","J","V","S","D"];
  dow.forEach(d=>{
    const el=document.createElement("div"); el.className="dow"; el.textContent=d; calGrid.appendChild(el);
  });
  const first = new Date(current.getFullYear(),current.getMonth(),1);
  const startIdx = (first.getDay()+6)%7; // Luni=0
  const daysInMonth = new Date(current.getFullYear(), current.getMonth()+1, 0).getDate();
  for(let i=0;i<startIdx;i++){ const filler=document.createElement("div"); calGrid.appendChild(filler); }
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(current.getFullYear(), current.getMonth(), d);
    const el = document.createElement("div");
    el.className = "day";
    el.textContent = d;
    if (toKey(date)===toKey(today)) el.classList.add("today");
    if (toKey(date)===toKey(selected)) el.classList.add("selected");
    el.addEventListener("click", ()=>{ selected = date; renderCalendar(); renderTasks(); });
    calGrid.appendChild(el);
  }
  // Buton „AZI” – vizibil doar dacă nu e selectată ziua curentă
  const showTodayBtn = (toKey(selected)!==toKey(today));
  todayBtn.style.display = showTodayBtn ? "inline-flex" : "none";
}

/* ===== Tasks Render ===== */
function pillForTag(tag){
  if(!tag) return "";
  const map = {
    "nu_raspunde": 'NU RĂSPUNDE',
    "vrea_oferta": 'VREA OFERTĂ',
    "semneaza": 'SEMNĂZĂ',
    "de_revenit": 'DE REVENIT'
  };
  let cls = "tag";
  if (tag==="vrea_oferta") cls = "tag offer";
  else if (tag==="semneaza") cls = "tag sign";
  else if (tag==="nu_raspunde") cls = "tag pink";
  else if (tag==="de_revenit") cls = "tag yellow";
  return `<span class="${cls}">${map[tag]}</span>`;
}

function renderTasks(){
  taskList.innerHTML = "";
  const key = toKey(selected);
  const items = loadDay(key);
  if(!items.length){
    taskList.innerHTML = `<div class="empty">N-ai nimic pe ${key}. Apasă ＋ pentru a adăuga.</div>`;
    return;
  }
  for(const t of items){
    const li = document.createElement("div");
    li.className = "task";
    if (t.done) li.classList.add("done");
    if (t.tag==="vrea_oferta") li.classList.add("highlight-offer");
    if (t.tag==="semneaza") li.classList.add("highlight-sign");
    if (t.tag==="nu_raspunde") li.classList.add("highlight-pink");
    if (t.tag==="de_revenit") li.classList.add("highlight-yellow");

    li.dataset.id = t.id;

    const act = document.createElement("div");
    act.className = "swipe-actions";
    act.innerHTML = `<div class="swipe-left">✓ făcut</div><div class="swipe-right">șterge</div>`;
    li.appendChild(act);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `${pillForTag(t.tag)} ${ t.movedFrom ? `<span class="tag">MUTAT DE PE ${t.movedFrom}</span>`:"" }`;

    const title = document.createElement("div");
    title.textContent = t.title;

    const note = document.createElement("div");
    note.className = "note";
    note.textContent = t.note || "";

    li.appendChild(meta);
    li.appendChild(title);
    if (t.note) li.appendChild(note);

    attachGestures(li, t);
    taskList.appendChild(li);
  }
}

/* ===== Gestures pe task: swipe & long-press ===== */
function attachGestures(el, task){
  let startX=0, startY=0, currentX=0, moved=false, pressTimer=null;

  const onStart=(clientX, clientY)=>{
    startX=clientX; startY=clientY; moved=false;
    pressTimer = setTimeout(()=>{ longPressTargetId = task.id; openTagModal(); }, 600);
  };
  const onMove=(clientX, clientY)=>{
    const dx = clientX - startX;
    const dy = clientY - startY;
    if (Math.hypot(dx,dy) > 10){ moved=true; clearTimeout(pressTimer); }
    if (moved){
      if (dx>0){ el.classList.add("swiping-left"); el.classList.remove("swiping-right"); }
      else { el.classList.add("swiping-right"); el.classList.remove("swiping-left"); }
      el.style.transform = `translateX(${dx}px)`;
    }
  };
  const onEnd=()=>{
    clearTimeout(pressTimer);
    const dx = (currentX - startX);
    const threshold = 80;
    if (!moved){ el.style.transform=""; el.classList.remove("swiping-left","swiping-right"); return; }
    if (dx > threshold){ toggleDone(task.id); }
    else if (dx < -threshold){ if (confirm("Ștergi acest task?")) removeTask(task.id); }
    el.style.transform=""; el.classList.remove("swiping-left","swiping-right");
  };

  // touch
  el.addEventListener("touchstart", e=> onStart(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
  el.addEventListener("touchmove",  e=> { currentX = e.touches[0].clientX; onMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive:true});
  el.addEventListener("touchend", onEnd);
  // mouse
  el.addEventListener("mousedown", e=> onStart(e.clientX, e.clientY));
  el.addEventListener("mousemove", e=>{ if(e.buttons===1){ currentX = e.clientX; onMove(e.clientX, e.clientY);} });
  el.addEventListener("mouseup", onEnd);
}

/* ===== CRUD ===== */
function createTask(key, data){
  const arr = loadDay(key);
  arr.push({id:uuid(), title:data.title, note:data.note||"", done:false, tag:null, movedFrom:null, createdAt:Date.now()});
  saveDay(key, arr);
  renderTasks();
}
function removeTask(id){
  const key = toKey(selected);
  let arr = loadDay(key);
  arr = arr.filter(x=>x.id!==id);
  saveDay(key, arr);
  renderTasks();
}
function toggleDone(id){
  const key = toKey(selected);
  const arr = loadDay(key);
  const t = arr.find(x=>x.id===id);
  if (!t) return;
  t.done = !t.done;
  saveDay(key, arr);
  renderTasks();
}

/* ===== Tag logic ===== */
function updateTagOnTask(dayKey, id, tag){
  const arr = loadDay(dayKey);
  const t = arr.find(x=>x.id===id);
  if(!t) return;
  t.tag = tag;
  saveDay(dayKey, arr);
  renderTasks();

  if (tag==="nu_raspunde"){
    // MUTĂ automat pe ziua următoare
    const srcKey = dayKey;
    const nextDate = fromKey(srcKey); nextDate.setDate(nextDate.getDate()+1);
    const nextKey = toKey(nextDate);

    // scoatem din ziua curentă
    const srcArr = loadDay(srcKey);
    const idx = srcArr.findIndex(x=>x.id===id);
    if (idx>-1){
      const [item] = srcArr.splice(idx,1);
      saveDay(srcKey, srcArr);
      item.movedFrom = srcKey;
      const dst = loadDay(nextKey);
      dst.push(item);
      saveDay(nextKey, dst);
      if (toKey(selected)===nextKey) renderTasks();
      alert(`Mutat automat pe ${nextKey}`);
    }
  }

  if (tag==="de_revenit"){
    // deschidem date-picker; mutarea se va face în saveDate()
    longPressTargetId = id;
    openDateModal();
  }
}

/* ===== Modals ===== */
function openAddModal(){ taskTitle.value=""; taskNote.value=""; modalAddBg.style.display="flex"; }
function closeAddModal(){ modalAddBg.style.display="none"; }
function openTagModal(){ modalTagBg.style.display="flex"; }
function closeTagModal(){ modalTagBg.style.display="none"; longPressTargetId=null; }

function openDateModal(){ returnDate.value = toKey(new Date()); modalDateBg.style.display="flex"; }
function closeDateModal(){ modalDateBg.style.display="none"; }

/* ===== Handlers ===== */
addBtn.onclick = openAddModal;
cancelAdd.onclick = closeAddModal;
saveAdd.onclick = ()=>{
  const title = taskTitle.value.trim();
  if(!title) return alert("Te rog scrie un titlu.");
  createTask(toKey(selected), {title, note:taskNote.value.trim()});
  closeAddModal();
};

prevBtn.onclick = ()=>{ current = new Date(current.getFullYear(), current.getMonth()-1, 1); renderCalendar(); };
nextBtn.onclick = ()=>{ current = new Date(current.getFullYear(), current.getMonth()+1, 1); renderCalendar(); };

document.querySelectorAll("#modalTagBg .chip").forEach(ch=>{
  ch.addEventListener("click", ()=>{
    const tag = ch.dataset.val;
    const key = toKey(selected);
    if (!longPressTargetId){ closeTagModal(); return; }
    updateTagOnTask(key, longPressTargetId, tag);
    closeTagModal();
  });
});
cancelTag.onclick = closeTagModal;

cancelDate.onclick = closeDateModal;
saveDate.onclick = ()=>{
  const dateStr = returnDate.value;
  if(!dateStr) return;
  const srcKey = toKey(selected);
  const id = longPressTargetId;

  // MUTĂ (nu duplică) task-ul pe data aleasă și marchează movedFrom
  const srcArr = loadDay(srcKey);
  const idx = srcArr.findIndex(x=>x.id===id);
  if (idx===-1){ closeDateModal(); return; }
  const [item] = srcArr.splice(idx,1);
  saveDay(srcKey, srcArr);

  item.movedFrom = srcKey;
  item.tag = "de_revenit";

  const dstArr = loadDay(dateStr);
  dstArr.push(item);
  saveDay(dateStr, dstArr);

  closeDateModal();
  alert(`Mutat pe ${dateStr}`);

  // dacă ne aflăm pe ziua destinație – reafișează; altfel rămânem pe ziua curentă
  if (toKey(selected)===dateStr) renderTasks(); else renderTasks();
};

/* Buton AZI */
todayBtn.onclick = ()=>{
  selected = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  current  = new Date(today.getFullYear(), today.getMonth(), 1);
  renderCalendar(); renderTasks();
};

/* ===== Swipe pe CALENDAR pentru schimbare lună ===== */
(function enableMonthSwipe(){
  let startX=0,startY=0,endX=0,endY=0,down=false;
  const threshold=60; // px
  const maxAngle=25;  // toleranță pe verticală

  const onDown=(x,y)=>{startX=x;startY=y;down=true;};
  const onMove=(x,y)=>{endX=x;endY=y;};
  const onUp=()=>{
    if(!down) return; down=false;
    const dx=endX-startX, dy=endY-startY;
    const angle = Math.abs(Math.atan2(dy,dx)*180/Math.PI);
    if (Math.abs(dx)>threshold && (angle<maxAngle || angle>180-maxAngle)){
      if (dx<0){ // swipe stânga -> luna următoare
        nextBtn.click();
      } else {   // swipe dreapta -> luna anterioară
        prevBtn.click();
      }
    }
  };

  // aplicăm pe header + calendar (zona de sus)
  const zone = document.querySelector('header');
  const zone2= calGrid;

  [zone, zone2].forEach(el=>{
    el.addEventListener('touchstart', e=>onDown(e.touches[0].clientX,e.touches[0].clientY), {passive:true});
    el.addEventListener('touchmove',  e=>onMove(e.touches[0].clientX,e.touches[0].clientY), {passive:true});
    el.addEventListener('touchend', onUp);
    el.addEventListener('mousedown', e=>onDown(e.clientX,e.clientY));
    el.addEventListener('mousemove', e=>{ if(e.buttons===1) onMove(e.clientX,e.clientY); });
    el.addEventListener('mouseup', onUp);
  });
})();

/* ===== Init ===== */
function init(){ renderCalendar(); renderTasks(); }
init();
</script>
</body>
</html>
